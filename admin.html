<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Handipass</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Accessibility Toolbar -->
    <link rel="stylesheet" href="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.css">
    <script src="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.js" defer></script>
    
    <!-- Protection par mot de passe -->
    <script>
        (function() {
            const isAuth = sessionStorage.getItem('handipass_admin_auth');
            
            if (!isAuth) {
                const password = prompt('Mot de passe administrateur requis :');
                const correctPassword = 'HandipassAdmin2026';
                
                if (password !== correctPassword) {
                    alert('Mot de passe incorrect. Accès refusé.');
                    window.location.href = '/';
                    return;
                }
                
                sessionStorage.setItem('handipass_admin_auth', 'true');
                sessionStorage.setItem('admin_password', password);
            }
        })();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background: linear-gradient(135deg, 
                #4a4a4a 0%, #4a4a4a 14.28%,
                #22c55e 14.28%, #22c55e 28.56%,
                #3b82f6 28.56%, #3b82f6 42.84%,
                #ffffff 42.84%, #ffffff 57.12%,
                #fbbf24 57.12%, #fbbf24 71.4%,
                #dc2626 71.4%, #dc2626 85.68%,
                #4a4a4a 85.68%, #4a4a4a 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        h1 {
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 2rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-weight: 600;
            font-family: 'Lexend', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #3b82f6;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .section h2 {
            color: #1a1a1a;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
        }

        input[type="text"],
        input[type="email"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-family: 'Lexend', sans-serif;
            font-size: 1rem;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        textarea {
            min-height: 200px;
            resize: vertical;
        }

        .btn {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-family: 'Lexend', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #22c55e;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .variable-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .variable-btn {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-family: 'Lexend', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .variable-btn:hover {
            background: #c7d2fe;
        }

        .item-list {
            list-style: none;
            margin-top: 1rem;
        }

        .item-list li {
            background: white;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #22c55e;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-free {
            background: #dcfce7;
            color: #166534;
        }

        .status-restricted {
            background: #fee2e2;
            color: #991b1b;
        }

        small {
            display: block;
            margin-top: 0.25rem;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .help-text {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .success-message {
            background: #d1fae5;
            border-left: 4px solid #22c55e;
            color: #065f46;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Administration Handipass</h1>
        <p class="subtitle">Gérez les thématiques et les modèles de courriers</p>

        <div class="loading" id="loading">Chargement des données...</div>

        <div id="main-content" style="display: none;">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('themes')">Thématiques</button>
                <button class="tab" onclick="switchTab('courriers')">Courriers</button>
            </div>

            <!-- Onglet Thématiques -->
            <div id="tab-themes" class="tab-content active">
                <div class="section">
                    <h2>Gestion des thématiques</h2>
                    <div class="help-text">
                        <strong>Libre / Réservé :</strong> Les thématiques libres sont accessibles à tous. Les thématiques réservées nécessitent une connexion.
                    </div>

                    <ul class="item-list" id="themes-list"></ul>
                </div>

                <div class="section">
                    <h2>Modifier une thématique</h2>
                    <div class="form-group">
                        <label for="theme-select">Sélectionnez une thématique</label>
                        <select id="theme-select" onchange="loadThemeForEdit()">
                            <option value="">-- Choisir --</option>
                        </select>
                    </div>

                    <div id="theme-editor" style="display: none;">
                        <div class="form-group">
                            <label for="theme-title">Titre</label>
                            <input type="text" id="theme-title">
                        </div>

                        <div class="form-group">
                            <label for="theme-description">Description courte</label>
                            <input type="text" id="theme-description">
                        </div>

                        <div class="form-group">
                            <label for="theme-content">Contenu complet (HTML autorisé)</label>
                            <textarea id="theme-content"></textarea>
                        </div>

                        <button class="btn btn-success" onclick="saveTheme()">Enregistrer les modifications</button>
                        <div id="theme-success" class="success-message"></div>
                    </div>
                </div>
            </div>

            <!-- Onglet Courriers -->
            <div id="tab-courriers" class="tab-content">
                <div class="section">
                    <h2>Gestion des courriers</h2>
                    <div class="help-text">
                        <strong>Libre / Réservé :</strong> Les courriers libres sont accessibles à tous. Les courriers réservés nécessitent une connexion.
                    </div>

                    <ul class="item-list" id="courriers-list"></ul>
                </div>

                <div class="section">
                    <h2>Modifier un courrier</h2>
                    <div class="form-group">
                        <label for="courrier-select">Sélectionnez un courrier</label>
                        <select id="courrier-select" onchange="loadCourrierForEdit()">
                            <option value="">-- Choisir --</option>
                        </select>
                    </div>

                    <div id="courrier-editor" style="display: none;">
                        <div class="form-group">
                            <label for="courrier-title">Titre du courrier</label>
                            <input type="text" id="courrier-title">
                        </div>

                        <div class="help-text">
                            <strong>Insérer des variables :</strong> Cliquez sur un bouton pour insérer une variable dans le modèle.
                        </div>

                        <div class="variable-buttons">
                            <button class="variable-btn" onclick="insertVariable('nom')">{{nom}}</button>
                            <button class="variable-btn" onclick="insertVariable('adresse')">{{adresse}}</button>
                            <button class="variable-btn" onclick="insertVariable('code_postal')">{{code_postal}}</button>
                            <button class="variable-btn" onclick="insertVariable('ville')">{{ville}}</button>
                            <button class="variable-btn" onclick="insertVariable('telephone')">{{telephone}}</button>
                            <button class="variable-btn" onclick="insertVariable('email')">{{email}}</button>
                            <button class="variable-btn" onclick="insertVariable('date')">{{date}}</button>
                            <button class="variable-btn" onclick="insertVariable('motif')">{{motif}}</button>
                            <button class="variable-btn" onclick="insertVariable('numero_decision')">{{numero_decision}}</button>
                            <button class="variable-btn" onclick="insertVariable('date_decision')">{{date_decision}}</button>
                            <button class="variable-btn" onclick="createCustomVariable()">+ Variable personnalisée</button>
                        </div>

                        <div class="form-group">
                            <label for="courrier-template">Modèle du courrier</label>
                            <textarea id="courrier-template" style="min-height: 400px;"></textarea>
                            <small>Utilisez les variables {{nom}}, {{adresse}}, etc. Le système les détectera automatiquement et créera les champs de formulaire.</small>
                        </div>

                        <button class="btn btn-success" onclick="saveCourrier()">Enregistrer les modifications</button>
                        <div id="courrier-success" class="success-message"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let themeData = {};
        let letterTemplates = {};

        async function loadData() {
            try {
                // Charger depuis jsDelivr CDN (GitHub)
                const themesResponse = await fetch('https://cdn.jsdelivr.net/gh/alixb-accessible/Handipass@main/public/themes-data.txt');
                const themesText = await themesResponse.text();
                eval(themesText);
                themeData = window.themeData;

                const courriersResponse = await fetch('https://cdn.jsdelivr.net/gh/alixb-accessible/Handipass@main/public/courriers-templates.txt');
                const courriersText = await courriersResponse.text();
                eval(courriersText);
                letterTemplates = window.letterTemplates;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';

                populateThemesList();
                populateThemeSelect();
                populateCouriersList();
                populateCourrierSelect();

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').innerHTML = '❌ Erreur de chargement. Veuillez recharger la page.';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'themes') {
                document.querySelector('[onclick="switchTab(\'themes\')"]').classList.add('active');
                document.getElementById('tab-themes').classList.add('active');
            } else {
                document.querySelector('[onclick="switchTab(\'courriers\')"]').classList.add('active');
                document.getElementById('tab-courriers').classList.add('active');
            }
        }

        function populateThemesList() {
            const list = document.getElementById('themes-list');
            list.innerHTML = '';
            Object.keys(themeData).forEach(themeId => {
                const theme = themeData[themeId];
                const isRestricted = theme.restricted === true;
                const li = document.createElement('li');
                li.innerHTML = `<div><strong>${theme.title}</strong><span class="status-badge ${isRestricted ? 'status-restricted' : 'status-free'}">${isRestricted ? 'Réservé' : 'Libre'}</span></div><label class="toggle-switch"><input type="checkbox" ${isRestricted ? '' : 'checked'} onchange="toggleThemeAccess('${themeId}', this.checked)"><span class="slider"></span></label>`;
                list.appendChild(li);
            });
        }

        function populateCouriersList() {
            const list = document.getElementById('courriers-list');
            list.innerHTML = '';
            Object.keys(letterTemplates).forEach(courrierId => {
                const courrier = letterTemplates[courrierId];
                const isRestricted = courrier.restricted === true;
                const li = document.createElement('li');
                li.innerHTML = `<div><strong>${courrier.title}</strong><span class="status-badge ${isRestricted ? 'status-restricted' : 'status-free'}">${isRestricted ? 'Réservé' : 'Libre'}</span></div><label class="toggle-switch"><input type="checkbox" ${isRestricted ? '' : 'checked'} onchange="toggleCourrierAccess('${courrierId}', this.checked)"><span class="slider"></span></label>`;
                list.appendChild(li);
            });
        }

        function toggleThemeAccess(themeId, isFree) {
            themeData[themeId].restricted = !isFree;
            saveDataToFile('public/themes-data.txt', 'themeData', themeData);
            populateThemesList();
        }

        function toggleCourrierAccess(courrierId, isFree) {
            letterTemplates[courrierId].restricted = !isFree;
            saveDataToFile('public/courriers-templates.txt', 'letterTemplates', letterTemplates);
            populateCouriersList();
        }

        function populateThemeSelect() {
            const select = document.getElementById('theme-select');
            select.innerHTML = '<option value="">-- Choisir --</option>';
            Object.keys(themeData).forEach(themeId => {
                const opt = document.createElement('option');
                opt.value = themeId;
                opt.textContent = themeData[themeId].title;
                select.appendChild(opt);
            });
        }

        function loadThemeForEdit() {
            const themeId = document.getElementById('theme-select').value;
            if (!themeId) {
                document.getElementById('theme-editor').style.display = 'none';
                return;
            }
            const theme = themeData[themeId];
            document.getElementById('theme-title').value = theme.title;
            document.getElementById('theme-description').value = theme.description || '';
            document.getElementById('theme-content').value = theme.content || '';
            document.getElementById('theme-editor').style.display = 'block';
        }

        function saveTheme() {
            const themeId = document.getElementById('theme-select').value;
            if (!themeId) return;
            themeData[themeId].title = document.getElementById('theme-title').value;
            themeData[themeId].description = document.getElementById('theme-description').value;
            themeData[themeId].content = document.getElementById('theme-content').value;
            saveDataToFile('public/themes-data.txt', 'themeData', themeData);
            const msg = document.getElementById('theme-success');
            msg.textContent = 'Thématique enregistrée avec succès !';
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 3000);
            populateThemesList();
            populateThemeSelect();
        }

        function populateCourrierSelect() {
            const select = document.getElementById('courrier-select');
            select.innerHTML = '<option value="">-- Choisir --</option>';
            Object.keys(letterTemplates).forEach(courrierId => {
                const opt = document.createElement('option');
                opt.value = courrierId;
                opt.textContent = letterTemplates[courrierId].title;
                select.appendChild(opt);
            });
        }

        function loadCourrierForEdit() {
            const courrierId = document.getElementById('courrier-select').value;
            if (!courrierId) {
                document.getElementById('courrier-editor').style.display = 'none';
                return;
            }
            const cour = letterTemplates[courrierId];
            document.getElementById('courrier-title').value = cour.title;
            document.getElementById('courrier-template').value = cour.template;
            document.getElementById('courrier-editor').style.display = 'block';
        }

        function insertVariable(varName) {
            const txt = document.getElementById('courrier-template');
            const pos = txt.selectionStart;
            const before = txt.value.substring(0, pos);
            const after = txt.value.substring(pos);
            txt.value = before + `{{${varName}}}` + after;
            txt.focus();
            txt.setSelectionRange(pos + varName.length + 4, pos + varName.length + 4);
        }

        function createCustomVariable() {
            const varName = prompt('Nom de la variable personnalisée (ex: nom_medecin) :');
            if (varName) insertVariable(varName.toLowerCase().replace(/\s+/g, '_'));
        }

        function saveCourrier() {
            const courrierId = document.getElementById('courrier-select').value;
            if (!courrierId) return;
            letterTemplates[courrierId].title = document.getElementById('courrier-title').value;
            letterTemplates[courrierId].template = document.getElementById('courrier-template').value;
            saveDataToFile('public/courriers-templates.txt', 'letterTemplates', letterTemplates);
            const msg = document.getElementById('courrier-success');
            msg.textContent = 'Courrier enregistré avec succès !';
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 3000);
            populateCouriersList();
            populateCourrierSelect();
        }

        async function saveDataToFile(filename, varName, data) {
            const content = `const ${varName} = ${JSON.stringify(data, null, 2)};`;
            if (!confirm(`Voulez-vous enregistrer les modifications dans ${filename} ?`)) return;
            const password = sessionStorage.getItem('admin_password');
            if (!password) {
                alert('Session expirée. Rechargez la page.');
                return;
            }
            try {
                const res = await fetch('/api/update-data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename, content, password})
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Erreur lors de la sauvegarde');
                }
                const result = await res.json();
                if (result.success) {
                    alert(`✅ ${filename} mis à jour avec succès ! Le site sera redéployé dans 2-3 minutes.`);
                } else {
                    throw new Error('Échec de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert(`❌ Erreur : ${error.message}`);
            }
        }

        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
